***********************************************************************

Levantar base de datos postgres:

sudo rm -rf postgres-reactive   ----> borrar carpeta con contenido
sudo mkdir postgres-reactive

sudo chown -R jchaconv:jchaconv /home/jchaconv/postgres-reactive   ---> dar permisos sudo
ls -ld postgres-reactive    --> ejecutar desde aquí /home/jchaconv/ para validar permisos

docker-compose up -d

Para testear:
docker exec -it reactive-postgres-banking psql -U user_banking -d fraud_db -c "SELECT customer_id, daily_max_amount FROM customer_limits;"
docker exec -it reactive-postgres-banking psql -U user_banking -d fraud_db -c "SELECT count(*) FROM transactions;"
docker exec -it reactive-postgres-banking psql -U user_banking -d fraud_db -c "SELECT * FROM transactions;"
docker exec -it reactive-postgres-banking psql -U user_banking -d fraud_db -c "SELECT * FROM transactions WHERE customer_id = 'CUST-001';"


Probar fraud-detection-service:

curl -X POST http://localhost:8081/api/v1/transactions \
-H "Content-Type: application/json" \
-d '{
    "transactionId": "TXN-2026-WEB-001",
    "customerId": "CUST-001",
    "accountId": "ACC-101",
    "amount": 500.00,
    "currency": "PEN",
    "operationType": "DEBIT",
    "channel": "WEB"
}'

docker exec -it reactive-postgres-banking psql -U user_banking -d fraud_db -c "SELECT * FROM customer_limits WHERE customer_id = 'CUST-001';"

docker exec -it reactive-postgres-banking psql -U user_banking -d fraud_db -c "SELECT * FROM outbox_events;"


-----------------------------------------

Configuración Kafka server:
       
- rm -rf /tmp/kafka-logs /tmp/zookeeper /tmp/kraft-combined-logs
- KAFKA_CLUSTER_ID="$(bin/kafka-storage.sh random-uuid)"
- echo $KAFKA_CLUSTER_ID
- bin/kafka-storage.sh format -t $KAFKA_CLUSTER_ID -c config/kraft/server.properties
- bin/kafka-server-start.sh config/kraft/server.properties

- bin/kafka-topics.sh --bootstrap-server localhost:9092 --list
- bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic fraud-detection-events --from-beginning

bin/kafka-console-consumer.sh --bootstrap-server 127.0.0.1:9092 \
--topic fraud-detection-events \
--from-beginning \
--formatter kafka.tools.DefaultMessageFormatter \
--property print.key=true \
--property print.value=true \
--property key.deserializer=org.apache.kafka.common.serialization.StringDeserializer \
--property value.deserializer=org.apache.kafka.common.serialization.StringDeserializer


- bin/kafka-topics.sh --bootstrap-server localhost:9092 --delete --topic fraud-detection-events

- bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --list

- bin/kafka-server-stop.sh

- to configure application.properties, for the wsl use: ip addr show, use the eth0  → spring.kafka.bootstrap-servers=172.30.84.55:9092
- edit server.properties with this:
    listeners=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
    advertised.listeners=PLAINTEXT://172.30.84.55:9092

- bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic fraud-detection-events-dlt --from-beginning

bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 \
--topic fraud-detection-events-dlt \
--from-beginning \
--property print.headers=true


-----------------------------------------

Levantar Redis:

docker run -d --name redis-banking -p 6379:6379 redis:latest

# Entrar al CLI del contenedor
docker exec -it redis-banking redis-cli
# 1. Listar todas las llaves (Cuidado en producción, es lento)
keys *
# 2. Buscar solo las de idempotencia
keys idempotency:txn:*
# 3. Ver el valor de una transacción específica
get idempotency:txn:TXN-ERROR-002
# 4. Ver cuánto tiempo de vida le queda (en segundos)
ttl idempotency:txn:TXN-ERROR-002

FLUSHALL   ---> para borrar todo

***********************************************************************

Para levantar todo el ecosistema:

sudo mkdir fraud-alert-system
sudo chown -R jchaconv:jchaconv /home/jchaconv/fraud-alert-system   ---> dar permisos sudo
ls -ld fraud-alert-system    --> ejecutar desde aquí /home/jchaconv/ para validar permisos

tener esta estructura:

fraud-alert-system/
├── auth-server/             (Carpeta del microservicio)
├── fraud-detection-service/ (Carpeta del microservicio)
├── notification-service/    (Carpeta del microservicio)
├── scripts/                 <-- AQUÍ pones el script
│   └── init.sql
└── docker-compose.yaml      <-- El YAML en la raíz

chmod 644 /home/jchaconv/fraud-alert-system/scripts/init.sql   ---> Permisos de ejecución: Asegúrate de que el archivo tenga permisos de lectura dentro de WSL
chmod +x auth-server/mvnw
chmod +x fraud-detection-service/mvnw
chmod +x notification-service/mvnw

docker-compose up --build -d     -----> cuando necesito compilar de nuevo las imágenes
docker-compose ps   --> verificar estados


Solo la primera vez: Recuerda que Postgres solo ejecuta los scripts en /docker-entrypoint-initdb.d/ la primera vez que se crea el volumen.
Si haces cambios en el init.sql y quieres que se reflejen, debes borrar el contenedor y su volumen:

docker-compose down   ----> para limpiar los containers
docker-compose up -d     ----> cuando solo hay cambios en el docker-compose.yaml

docker logs -f fraud-detection-service
docker logs -f notification-service
docker logs -f auth-server


docker exec kafka-banking /opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list
docker exec -it reactive-postgres-banking psql -U user_banking -d fraud_db
SELECT * FROM transactions WHERE customer_id = 'CUST-001';

docker exec -it redis-banking redis-cli

curl http://localhost:8081/actuator/health

poner en hosts: 127.0.0.1 auth-server para que se genere la firma con ese host y no con uno no autorizado como "localhost"

test outbox:

docker stop kafka-banking

docker exec -it reactive-postgres-banking psql -U user_banking -d fraud_db -c "SELECT * FROM transactions WHERE customer_id = 'CUST-001';"
docker exec -it reactive-postgres-banking psql -U user_banking -d fraud_db -c "SELECT * FROM outbox_events;"

docker start kafka-banking

---------------------------------------------------------

Kubernetes Config:

---------------------
Install kubectl:
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

# Verifica con:
kubectl version --client
---------------------
Install Kind:

curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind
---------------------
Crear primer cluster:
kind create cluster --name banking-cluster

Validar acceso:
kubectl cluster-info
kubectl get nodes
---------------------
Crear namespace:
kubectl create namespace banking-ns
---------------------
Crear un ConfigMap -> usar banking-config.yaml
kubectl apply -f banking-config.yaml
---------------------
Para configurar Postgres
Persistent Volume Claim -> postgres-pvc.yaml -> le dice a K8S "Resérvame 1GB de disco que sobreviva a reinicios".
También se usará el archivo postgres-db.yaml

# 1. Aplicar los archivos
kubectl apply -f postgres-pvc.yaml
kubectl apply -f postgres-db.yaml

# 2. Verificar que el Pod esté corriendo
kubectl get pods -n banking-ns

# 3. Verificar el Service (Este es el que usará tu Java app)
kubectl get svc -n banking-ns

* Self-Healing:
Si ejecuto esto:
kubectl delete pod <nombre-del-pod-postgres> -n banking-ns
K8s creará uno nuevo automáticamente

---------------------

Construir imágenes para subir a Docker Hub

Configurar PAT en Docker Hub -> settings

docker login -u jchaconv   -> luego pedirá el token
docker logout

# 1. Construir la imagen (asegúrate de estar en la carpeta del proyecto)
docker build -t jchaconv/fraud-detection-service:latest .

# 2. Subirla a la nube (Push)
docker push jchaconv/fraud-detection-service:latest

Ver en la parte de repositories de Docker Hub la imagen subida.
---------------------
Config de Redis:
usar redis-k8s.yaml
kubectl apply -f redis-k8s.yaml
---------------------
Crear fraud-service-deployment.yaml
kubectl apply -f fraud-service-deployment.yaml
Verificar el estado:
# Ver si el pod está en Running o da error
kubectl get pods -n banking-ns

# Ver los logs de tu Spring Boot para confirmar conexión a DB y Redis
kubectl logs -f deployment/fraud-detection-app -n banking-ns

Como estoy usando wsl sale error para descargar de internet. Vamos a inyectar directamente
desde mi máquina al cluster:
# 1. Cargar Postgres
docker pull postgres:15-alpine
kind load docker-image postgres:15-alpine --name banking-cluster

# 2. Cargar Redis
docker pull redis:7-alpine
kind load docker-image redis:7-alpine --name banking-cluster

# 3. Cargar tu App
kind load docker-image jchaconv/fraud-detection-service:latest --name banking-cluster

esta línea debe estar en los archivos(solo los tres de abajo) yaml: imagePullPolicy: IfNotPresent

Reiniciar despliegues:
kubectl apply -f postgres-db.yaml
kubectl apply -f redis-k8s.yaml
kubectl apply -f fraud-service-deployment.yaml

Verificar:
kubectl get pods -n banking-ns

Meter bien el init.sql para la base de datos:
kubectl create configmap postgres-init-script --from-file=init.sql -n banking-ns

actualizar el archivo de postgres (ya lo tengo actualizado)

# 1. Borramos el despliegue actual
kubectl delete deployment postgres-db -n banking-ns

# 2. Borramos el PVC para limpiar los datos previos (OJO: Esto borra tus datos actuales)
kubectl delete pvc postgres-pvc -n banking-ns

# 3. Aplicamos todo de nuevo
kubectl apply -f postgres-pvc.yaml
kubectl apply -f postgres-db.yaml

kubectl logs -f deployment/postgres-db -n banking-ns
---------------------
Probar App:
Hacer tunnel primero
kubectl port-forward svc/fraud-detection-entrypoint 8081:8081 -n banking-ns
http://localhost:8081/actuator/health
---------------------
Config Kafka -> usar kafka-k8s.yaml
docker pull apache/kafka:3.7.0
kind load docker-image apache/kafka:3.7.0 --name banking-cluster
kubectl apply -f kafka-k8s.yaml
kubectl logs -f deployment/kafka-db -n banking-ns
---------------------
Auth-Server:
# Construir la imagen
docker build -t jchaconv/auth-server:latest .

# Cargarla a Kind para evitar el error de descarga en WSL
kind load docker-image jchaconv/auth-server:latest --name banking-cluster

kubectl apply -f auth-server-k8s.yaml

Tunnel para Postman:
Para usar exactamente la misma URL localhost:9000 desde Windows:
kubectl port-forward svc/auth-service 9000:9000 -n banking-ns

kubectl logs -f deployment/auth-server -n banking-ns

---------------------
notification-service:

# 1. Construir la imagen
docker build -t jchaconv/notification-service:latest .

# 2. Inyectarla a Kind
kind load docker-image jchaconv/notification-service:latest --name banking-cluster

kubectl apply -f notification-service-k8s.yaml

---------------------

Probar:
kubectl logs -f deployment/fraud-detection-app -n banking-ns
kubectl logs -f deployment/notification-service -n banking-ns

# Entrar directo al prompt de SQL
kubectl exec -it postgres-db-5b9f955d7-czvjd -n banking-ns -- psql -U jchacon -d fraud_db
\dt
SELECT * FROM customer_limits;
SELECT * FROM outbox_events;
SELECT * FROM transactions;
\q

# Entrar directo al cliente de Redis
kubectl exec -it redis-db-7bf66994d7-cx4pf -n banking-ns -- redis-cli

KEYS *
GET <key_name>
FLUSHALL
exit


Si quiero usar DBeaver, necesito tunnel:
kubectl port-forward svc/postgres-service 5432:5432 -n banking-ns


Validar si el pod puede ver a otro:
kubectl exec -it fraud-detection-app-6d7d5f6758-mrghd -n banking-ns -- curl -v http://auth-service:9000/.well-known/openid-configuration


Si se hace un nuevo deploy, para asegurar que tome las nuevas variables del archivo .yaml:
kubectl rollout restart deployment/fraud-detection-app -n banking-ns


# Ejecuta este comando para activar logs detallados de seguridad
kubectl set env deployment/fraud-detection-app \
  logging.level.org.springframework.security=DEBUG \
  logging.level.org.springframework.security.oauth2=DEBUG \
  -n banking-ns


# Para probar con Kafka caído:
kubectl scale deployment kafka-db --replicas=0 -n banking-ns
kubectl get pods -n banking-ns

kubectl scale deployment kafka-db --replicas=1 -n banking-ns

Pruebas hasta aquí ok, happy path y error con Kafka caído.

***********************************************************************

HELM:

* Install helm:
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    helm version

* Activar autocompletado:
    echo "source <(helm completion bash)" >> ~/.bashrc
    source ~/.bashrc

* Crear esta estructura de carpetas:

    banking-system-chart/
    ├── Chart.yaml
    ├── values.yaml
    └── templates/
        └── fraud-service.yaml

* Dry Run - sirve para DEBUG (simula el despliegue sin aplicar nada, para ver qué YAML generaría):
    helm install banking-app ./banking-system-chart --dry-run --debug

* Validar chart:
    helm lint ./banking-system-chart

* Crear el cluster de K8s:
    kind create cluster --name banking-cluster
    kubectl create namespace banking-ns

* Instalar:
    helm install banking-app ./banking-system-chart -n banking-ns

    Si se requiere borrar lo instalado:
    helm uninstall banking-app -n default
    kubectl delete all --all -n banking-ns

* Error de red:
    kind load docker-image jchaconv/fraud-detection-service:latest --name banking-cluster
    kind load docker-image jchaconv/auth-server:latest --name banking-cluster
    kind load docker-image jchaconv/notification-service:latest --name banking-cluster    
    kind load docker-image apache/kafka:3.7.0 --name banking-cluster
    kind load docker-image postgres:15-alpine --name banking-cluster
    kind load docker-image redis:7-alpine --name banking-cluster

* Validar recursos:
    kubectl get all -n banking-ns

* Post-instalación:
    kubectl get pods -n banking-ns -w
    helm list -n banking-ns
    kubectl logs deployment/postgres-db -n banking-ns

* Hacer tunnel al service:
    kubectl port-forward svc/fraud-detection-app-entrypoint 8081:8081 -n banking-ns
    kubectl port-forward svc/auth-service 9000:9000 -n banking-ns

* Ejecutar SQL y ver logs:    
    - postgresql:
        kubectl exec -it deployment/postgres-db -n banking-ns -- psql -U jchacon -d fraud_db
            \dt
            SELECT * FROM customer_limits;
            SELECT * FROM outbox_events;
            \q

    - redis:
        kubectl exec -it deployment/redis-db -n banking-ns -- redis-cli

    - fraud-service
        kubectl logs -f deployment/fraud-detection-app -n banking-ns
    
    - notification-service
        kubectl logs -f deployment/notification-service -n banking-ns

    - Si se reinició el pod y se quiere ver error anterior:
        kubectl logs deployment/fraud-detection-app -n banking-ns --previous

* Probar happy path:ok, para probar con Kafka caído:ok

    kubectl scale deployment kafka-db --replicas=0 -n banking-ns
    kubectl get pods -n banking-ns
    kubectl scale deployment kafka-db --replicas=1 -n banking-ns

* Para borrar solo la aplicación manteniendo el cluster y la infraestructura base
    helm uninstall banking-app -n banking-ns

* Para borrar todo el cluster de Kind de raíz
    kind delete cluster --name banking-cluster

***********************************************************************